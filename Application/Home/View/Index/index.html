<div class="row panel panel-default" style="padding: 15px;">
    <div class="panel-body">
        <div class="row"><h4>欢迎来到定制后台！</h4></div>
        <div class="row">
            <div id="preview">
                <notempty name="admin.portrait">
                <img id="imghead" style="max-width: 10%; max-height: 200px;" border=1 src="{$Think.config.IMG_HOST}{$admin.portrait}">
            </notempty>
            </div><br>
            登录管理员：<b>{:session('nickname')}</b>
            <br>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content col-xs-10">
    <form id="setpasswdform" name="setpasswdform" action="__CONTROLLER__/setpasswd" method="post">
        <input type="hidden" name="issetpasswd" value="{$issetpasswd}" />
      <div class="modal-header">
        <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>-->
        <h4 class="modal-title" id="myModalLabel">修改密码</h4>
      </div>

      <div class="modal-body">
        <div class="alert alert-info alert-dismissible" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <if condition="$issetpasswd eq 1">
            您是第一次登录本系统，请设置一个属于自己的密码吧！
        <elseif condition="$issetpasswd eq 2"/>
            由于您的账户有安全隐患，所以请重设一个密码！
        <elseif condition="$issetpasswd eq 3"/>
            您的密码已被管理员重置，现在请设置一个属于自己的密码吧！
        <else />
        </if>
      </div>
        <div class="form-group">
            <label for="inputpasswd" class='col-xs-12'>输入密码</label>
            <div class="col-xs-8">
            <input type="password" class="form-control" id="inputpasswd" name="inputpasswd" placeholder="输入密码">
            </div><span class="" id="inputpasswdtxt"></span>
        </div><br/>
        <div class="form-group">
            <label for="inputrepasswd" class='col-xs-12'>再输一次</label>
            <div class="col-xs-8">
            <input type="password" class="form-control" id="inputrepasswd" name="inputrepasswd" placeholder="再输一次">
            </div><span class="" id="inputrepasswdtxt"></span>
        </div>
        <div class='clearfix'></div><br/>
        <div class='col-xs-12'><p class="text-muted glyphicon glyphicon-info-sign">请输入6~16位数字，字母或常用字符，字母区分大小写，密码强度至少<i class="text-danger">中级</i></p></div><br/>
        
      </div>
      <div class="modal-footer">
        <!--<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>-->
        <button type="submit" id="btn01" form="setpasswdform" class="btn" disabled>设置密码...</button>
      </div>
    </form>
    </div>
  </div>
</div>
<if condition="$issetpasswd gt 0">
<script>
$(function(){
    $('#myModal').modal({backdrop: 'static', keyboard: false});
    $('#inputpasswd').keyup(function(){
            var r= passwordLevel($(this).val());
            txtLevel(r, $("#inputpasswdtxt"));
            checkrepasswd($("#inputrepasswd").val(), $("#inputrepasswdtxt"));
    });
    $('#inputrepasswd').keyup(function(){
            //var r= passwordLevel($(this).val());
            //txtLevel(r, $("#inputrepasswdtxt"));
            checkrepasswd($(this).val(), $("#inputrepasswdtxt"));
    });
});

function checkrepasswd(val, obj){
    if(val != $('#inputpasswd').val()){
        obj.text("密码不一致");
        obj.removeClass().addClass("text-danger");
        changeBtn(false);
    }else if(passwordLevel(val)<2){
        obj.text("密码强度不足");
        obj.removeClass().addClass("text-danger");
        changeBtn(false);
    }else{
        obj.text("密码一致");
        obj.removeClass().addClass("text-success");
        changeBtn(true);
    }
}

function changeBtn(isdisable){
    if(isdisable){
        $("#btn01").attr("disabled", false);
        $("#btn01").addClass("btn-default");
        $("#btn01").text('保存');
    }else{
        $("#btn01").attr("disabled", true);
        $("#btn01").text('设置密码...');
    }
}

function txtLevel(level, obj){
    if (level < 2){
        obj.text("密码强度：低");
        obj.removeClass().addClass("text-danger");
    }else if(level <3){
        obj.text("密码强度：中");
        obj.removeClass().addClass("text-warning");
    }else{
        obj.text("密码强度：高");
        obj.removeClass().addClass("text-success");
    }
}
function passwordLevel(password) {
    var Modes = 0;
    for (i = 0; i < password.length; i++) {
        Modes |= CharMode(password.charCodeAt(i));
    }
    var result = bitTotal(Modes);
    if(password.length<6){
        if(result>=2){
            result = 1;
        }
    }
    return result;

    //CharMode函数
    function CharMode(iN) {
        if (iN >= 48 && iN <= 57)//数字
            return 1;
        if (iN >= 65 && iN <= 90) //大写字母
            return 2;
        if ((iN >= 97 && iN <= 122) || (iN >= 65 && iN <= 90)) //大小写
            return 4;
        else
            return 8; //特殊字符
    }

    //bitTotal函数
    function bitTotal(num) {
        modes = 0;
        for (i = 0; i < 4; i++) {
            if (num & 1) modes++;
            num >>>= 1;
        }
        return modes;
    }
}
</script>
</if>
